
#include "rw_sh1106.h"
#include "main.h"

// External drawing flag from main.c
extern uint8_t oled_drawing_in_progress;

#define SH1106_SETCONTRAST 0x81
#define SH1106_DISPLAYALLON_RESUME 0xA4
#define SH1106_DISPLAYALLON 0xA5
#define SH1106_NORMALDISPLAY 0xA6
#define SH1106_INVERTDISPLAY 0xA7
#define SH1106_DISPLAYOFF 0xAE
#define SH1106_DISPLAYON 0xAF

#define SH1106_SETDISPLAYOFFSET 0xD3
#define SH1106_SETCOMPINS 0xDA

#define SH1106_SETVCOMDETECT 0xDB

#define SH1106_SETDISPLAYCLOCKDIV 0xD5
#define SH1106_SETPRECHARGE 0xD9

#define SH1106_SETMULTIPLEX 0xA8

#define SH1106_SETLOWCOLUMN 0x00
#define SH1106_SETHIGHCOLUMN 0x10

#define SH1106_SETSTARTLINE 0x40

#define SH1106_MEMORYMODE 0x20
#define SH1106_COLUMNADDR 0x21
#define SH1106_PAGEADDR   0x22

#define SH1106_COMSCANINC 0xC0
#define SH1106_COMSCANDEC 0xC8

#define SH1106_SEGREMAP 0xA0

#define SH1106_CHARGEPUMP 0x8D

#define SH1106_EXTERNALVCC 0x1
#define SH1106_SWITCHCAPVCC 0x2

// Scrolling #defines
#define SH1106_ACTIVATE_SCROLL 0x2F
#define SH1106_DEACTIVATE_SCROLL 0x2E
#define SH1106_SET_VERTICAL_SCROLL_AREA 0xA3
#define SH1106_RIGHT_HORIZONTAL_SCROLL 0x26
#define SH1106_LEFT_HORIZONTAL_SCROLL 0x27
#define SH1106_VERTICAL_AND_RIGHT_HORIZONTAL_SCROLL 0x29
#define SH1106_VERTICAL_AND_LEFT_HORIZONTAL_SCROLL 0x2A

extern uint8_t font[];
uint8_t ssd1306_column = 0;
uint8_t ssd1306_row = 0;

void _cmd(uint8_t arg)
{
	rw_sh1106_pins_set(false, false, true); //cs dc rst
	rw_sh1106_spi_write(&arg, 1);
}

void _data(uint8_t *data, size_t len)
{
	rw_sh1106_pins_set(false, true, true); //cs dc rst
	rw_sh1106_spi_write(data, len);
}

void _data1(uint8_t arg)
{
	rw_sh1106_pins_set(false, true, true); //cs dc rst
	rw_sh1106_spi_write(&arg, 1);
}

void rw_sh1106_init(void)
{
	rw_sh1106_pins_set(true, true, false); //cs dc rst
	HAL_Delay(1);
	rw_sh1106_pins_set(true, true, true); //cs dc rst
	
	uint8_t vccstate = SH1106_SWITCHCAPVCC;
	rw_sh1106_pins_set(true, false, true); //cs dc rst
	_cmd(SH1106_DISPLAYOFF); // 0xAE
	_cmd(SH1106_SETDISPLAYCLOCKDIV); // 0xD5
	_cmd(0x80); // the suggested ratio 0x80
	_cmd(SH1106_SETMULTIPLEX); // 0xA8
	_cmd(0x3F);
	_cmd(SH1106_SETDISPLAYOFFSET); // 0xD3
	_cmd(0x00); // no offset
	_cmd(SH1106_SETSTARTLINE);
        
	_cmd(SH1106_SETSTARTLINE | 0x0); // line #0 0x40
	_cmd(SH1106_CHARGEPUMP); // 0x8D
	if (vccstate == SH1106_EXTERNALVCC) 
	{ _cmd(0x10); }
	else 
	{ _cmd(0x14); }
	_cmd(SH1106_MEMORYMODE); // 0x20
	_cmd(0x00); // 0x0 act like ks0108
	_cmd(SH1106_SEGREMAP | 0x1);
	_cmd(SH1106_COMSCANDEC);
	_cmd(SH1106_SETCOMPINS); // 0xDA
	_cmd(0x12);
	_cmd(SH1106_SETCONTRAST); // 0x81
	if (vccstate == SH1106_EXTERNALVCC) 
	{ _cmd(0x9F); }
	else 
	{ _cmd(0xCF); }
	_cmd(SH1106_SETPRECHARGE); // 0xd9
	if (vccstate == SH1106_EXTERNALVCC) 
	{ _cmd(0x22); }
	else 
	{ _cmd(0xF1); }
	_cmd(SH1106_SETVCOMDETECT); // 0xDB
	_cmd(0x40);
	_cmd(SH1106_DEACTIVATE_SCROLL);
	_cmd(SH1106_DISPLAYALLON_RESUME); // 0xA4
	_cmd(SH1106_NORMALDISPLAY); // 0xA6
	_cmd(SH1106_DISPLAYON);
	rw_sh1106_pins_set(true, true, true); //cs dc rst
}

void rw_sh1106_setposition(uint8_t column, uint8_t row)
{
	uint8_t x = column * 6 + 2;
	_cmd(SH1106_MEMORYMODE);
	_cmd(0x10);
	_cmd(x & 0x0F);
	_cmd(((x & 0xF0) >> 4) | 0x10);
	_cmd(row | 0xB0);
}

void rw_sh1106_char(char c)
{
	if ((c == 10) || (c == 13))
	{
		ssd1306_column = 0; ssd1306_row++;
	}
	else
	{
		if (ssd1306_row < 9)
		{
			uint32_t font_index = (c * 5);
			rw_sh1106_setposition(ssd1306_column, ssd1306_row);
			for (char i = 0; i < 5; i++)
			{
				_data1(font[font_index + i]);
			}
			ssd1306_column++;
		}
		if (ssd1306_column >= 21)	{ssd1306_row++; ssd1306_column = 0; }
		if (ssd1306_row >= 8){	ssd1306_row = 9; }
	}
}

void rw_sh1106_print(char *str)
{
	rw_display_drawing_start();
	int i = 0;
	while ((str[i] > 0)&&(i < 256))
	{
		rw_sh1106_char(str[i++]);
	}
	rw_display_drawing_end();
}

void rw_sh1106_fill(uint8_t pattern)
{
	rw_display_drawing_start();
	for (char row = 0; row < 8; row++)
	{
		rw_sh1106_setposition(0, row);
		for (uint16_t i = 0; i < 128; i++)
		{
			_data1(pattern);
		}
	}
	rw_display_drawing_end();
}

uint8_t font[] = {
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x3E, 0x55, 0x51, 0x55, 0x3E,
	0x3E, 0x6B, 0x6F, 0x6B, 0x3E,
	0x0C, 0x1E, 0x3C, 0x1E, 0x0C,
	0x08, 0x1C, 0x3E, 0x1C, 0x08,
	0x1C, 0x4A, 0x7F, 0x4A, 0x1C,
	0x18, 0x5C, 0x7F, 0x5C, 0x18,
	0x00, 0x1C, 0x1C, 0x1C, 0x00,
	0x7F, 0x63, 0x63, 0x63, 0x7F,
	0x00, 0x1C, 0x14, 0x1C, 0x00,
	0x7F, 0x63, 0x6B, 0x63, 0x7F,
	0x30, 0x48, 0x4D, 0x33, 0x07,
	0x06, 0x29, 0x79, 0x29, 0x06,
	0x20, 0x50, 0x3F, 0x02, 0x0C,
	0x60, 0x7F, 0x05, 0x35, 0x3F,
	0x2A, 0x1C, 0x77, 0x1C, 0x2A,
	0x00, 0x7F, 0x3E, 0x1C, 0x08,
	0x08, 0x1C, 0x3E, 0x7F, 0x00,
	0x14, 0x22, 0x7F, 0x22, 0x14,
	0x00, 0x5F, 0x00, 0x5F, 0x00,
	0x06, 0x09, 0x7F, 0x01, 0x7F,
	0x4A, 0x55, 0x55, 0x55, 0x29,
	0x60, 0x60, 0x60, 0x60, 0x60,
	0x54, 0x62, 0x7F, 0x62, 0x54,
	0x08, 0x04, 0x7E, 0x04, 0x08,
	0x08, 0x10, 0x3F, 0x10, 0x08,
	0x08, 0x08, 0x2A, 0x1C, 0x08,
	0x08, 0x1C, 0x2A, 0x08, 0x08,
	0x1C, 0x10, 0x10, 0x10, 0x10,
	0x1C, 0x3E, 0x08, 0x3E, 0x1C,
	0x30, 0x3C, 0x3F, 0x3C, 0x30,
	0x06, 0x1E, 0x7E, 0x1E, 0x06,
	0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x5F, 0x00, 0x00,
	0x00, 0x07, 0x00, 0x07, 0x00,
	0x14, 0x7F, 0x14, 0x7F, 0x14,
	0x24, 0x2A, 0x7F, 0x2A, 0x12,
	0x23, 0x13, 0x08, 0x64, 0x62,
	0x36, 0x49, 0x56, 0x20, 0x50,
	0x00, 0x00, 0x07, 0x00, 0x00,
	0x00, 0x1C, 0x22, 0x41, 0x00,
	0x00, 0x41, 0x22, 0x1C, 0x00,
	0x14, 0x08, 0x3E, 0x08, 0x14,
	0x08, 0x08, 0x3E, 0x08, 0x08,
	0x00, 0xA0, 0x60, 0x00, 0x00,
	0x08, 0x08, 0x08, 0x08, 0x08,
	0x00, 0x60, 0x60, 0x00, 0x00,
	0x20, 0x10, 0x08, 0x04, 0x02,
	0x3E, 0x51, 0x49, 0x45, 0x3E,
	0x44, 0x42, 0x7F, 0x40, 0x40,
	0x42, 0x61, 0x51, 0x49, 0x46,
	0x21, 0x41, 0x45, 0x4B, 0x31,
	0x18, 0x14, 0x12, 0x7F, 0x10,
	0x27, 0x45, 0x45, 0x45, 0x39,
	0x3C, 0x4A, 0x49, 0x49, 0x30,
	0x01, 0x71, 0x09, 0x05, 0x03,
	0x36, 0x49, 0x49, 0x49, 0x36,
	0x06, 0x49, 0x49, 0x29, 0x1E,
	0x00, 0x6C, 0x6C, 0x00, 0x00,
	0x00, 0xAC, 0x6C, 0x00, 0x00,
	0x08, 0x14, 0x22, 0x41, 0x00,
	0x14, 0x14, 0x14, 0x14, 0x14,
	0x00, 0x41, 0x22, 0x14, 0x08,
	0x02, 0x01, 0x51, 0x09, 0x06,
	0x3E, 0x41, 0x5D, 0x55, 0x5E,
	0x7C, 0x12, 0x11, 0x12, 0x7C,
	0x7F, 0x49, 0x49, 0x49, 0x36,
	0x3E, 0x41, 0x41, 0x41, 0x22,
	0x7F, 0x41, 0x41, 0x22, 0x1C,
	0x7F, 0x49, 0x49, 0x49, 0x41,
	0x7F, 0x09, 0x09, 0x09, 0x01,
	0x3E, 0x41, 0x49, 0x49, 0x7A,
	0x7F, 0x08, 0x08, 0x08, 0x7F,
	0x00, 0x41, 0x7F, 0x41, 0x00,
	0x20, 0x40, 0x41, 0x3F, 0x01,
	0x7F, 0x08, 0x14, 0x22, 0x41,
	0x7F, 0x40, 0x40, 0x40, 0x60,
	0x7F, 0x02, 0x0C, 0x02, 0x7F,
	0x7F, 0x04, 0x08, 0x10, 0x7F,
	0x3E, 0x41, 0x41, 0x41, 0x3E,
	0x7F, 0x09, 0x09, 0x09, 0x06,
	0x3E, 0x41, 0x51, 0x21, 0x5E,
	0x7F, 0x09, 0x19, 0x29, 0x46,
	0x46, 0x49, 0x49, 0x49, 0x31,
	0x03, 0x01, 0x7F, 0x01, 0x03,
	0x3F, 0x40, 0x40, 0x40, 0x3F,
	0x1F, 0x20, 0x40, 0x20, 0x1F,
	0x3F, 0x40, 0x3C, 0x40, 0x3F,
	0x63, 0x14, 0x08, 0x14, 0x63,
	0x07, 0x08, 0x70, 0x08, 0x07,
	0x61, 0x51, 0x49, 0x45, 0x43,
	0x00, 0x7F, 0x41, 0x41, 0x00,
	0x02, 0x04, 0x08, 0x10, 0x20,
	0x00, 0x41, 0x41, 0x7F, 0x00,
	0x04, 0x02, 0x01, 0x02, 0x04,
	0x40, 0x40, 0x40, 0x40, 0x40,
	0x00, 0x01, 0x02, 0x04, 0x00,
	0x20, 0x54, 0x54, 0x54, 0x78,
	0x7F, 0x48, 0x44, 0x44, 0x38,
	0x38, 0x44, 0x44, 0x44, 0x48,
	0x38, 0x44, 0x44, 0x48, 0x7F,
	0x38, 0x54, 0x54, 0x54, 0x18,
	0x08, 0x7E, 0x09, 0x01, 0x02,
	0x08, 0x54, 0x54, 0x58, 0x3C,
	0x7F, 0x08, 0x04, 0x04, 0x78,
	0x00, 0x44, 0x7D, 0x40, 0x00,
	0x20, 0x40, 0x44, 0x3D, 0x00,
	0x7F, 0x10, 0x10, 0x28, 0x44,
	0x00, 0x41, 0x7F, 0x40, 0x00,
	0x7C, 0x04, 0x78, 0x04, 0x78,
	0x7C, 0x08, 0x04, 0x04, 0x78,
	0x38, 0x44, 0x44, 0x44, 0x38,
	0x7C, 0x14, 0x14, 0x14, 0x08,
	0x08, 0x14, 0x14, 0x0C, 0x7C,
	0x7C, 0x08, 0x04, 0x04, 0x08,
	0x48, 0x54, 0x54, 0x54, 0x24,
	0x04, 0x3F, 0x44, 0x40, 0x20,
	0x3C, 0x40, 0x40, 0x20, 0x7C,
	0x1C, 0x20, 0x40, 0x20, 0x1C,
	0x3C, 0x40, 0x38, 0x40, 0x3C,
	0x44, 0x28, 0x10, 0x28, 0x44,
	0x0C, 0x50, 0x50, 0x50, 0x3C,
	0x44, 0x64, 0x54, 0x4C, 0x44,
	0x00, 0x08, 0x36, 0x41, 0x00,
	0x00, 0x00, 0x7F, 0x00, 0x00,
	0x00, 0x41, 0x36, 0x08, 0x00,
	0x02, 0x01, 0x02, 0x04, 0x02,
	0x70, 0x48, 0x44, 0x48, 0x70,
	0x00, 0x0E, 0x11, 0x0E, 0x00,
	0x00, 0x12, 0x1F, 0x10, 0x00,
	0x00, 0x12, 0x19, 0x16, 0x00,
	0x00, 0x11, 0x15, 0x0B, 0x00,
	0x00, 0x07, 0x04, 0x1F, 0x00,
	0x00, 0x17, 0x15, 0x09, 0x00,
	0x00, 0x0E, 0x15, 0x09, 0x00,
	0x00, 0x01, 0x1D, 0x03, 0x00,
	0x00, 0x0A, 0x15, 0x0A, 0x00,
	0x00, 0x12, 0x15, 0x0E, 0x00,
	0x00, 0x04, 0x04, 0x04, 0x00,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x3E, 0x00, 0x00, 0x00, 0x00,
	0x3E, 0x3E, 0x00, 0x00, 0x00,
	0x3E, 0x3E, 0x00, 0x3E, 0x00,
	0x3E, 0x3E, 0x00, 0x3E, 0x3E,
	0x80, 0x80, 0x80, 0x80, 0x80,
	0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
	0xD0, 0xD0, 0xD0, 0xD0, 0xD0,
	0xD8, 0xD8, 0xD8, 0xD8, 0xD8,
	0xDA, 0xDA, 0xDA, 0xDA, 0xDA,
	0xDB, 0xDB, 0xDB, 0xDB, 0xDB,
	0x40, 0x00, 0x40, 0x00, 0x40,
	0x60, 0x00, 0x40, 0x00, 0x40,
	0x60, 0x00, 0x70, 0x00, 0x40,
	0x60, 0x00, 0x70, 0x00, 0x78,
	0x7C, 0x00, 0x40, 0x00, 0x40,
	0x7C, 0x00, 0x7E, 0x00, 0x40,
	0x7C, 0x00, 0x7E, 0x00, 0x7F,
	0x1C, 0x77, 0x41, 0x41, 0x41,
	0x41, 0x41, 0x41, 0x41, 0x41,
	0x41, 0x41, 0x41, 0x7F, 0x00,
	0x1C, 0x77, 0x41, 0x5D, 0x5D,
	0x41, 0x41, 0x41, 0x5D, 0x5D,
	0x5D, 0x5D, 0x41, 0x5D, 0x5D,
	0x5D, 0x5D, 0x41, 0x7F, 0x00,
	0x22, 0x1C, 0x14, 0x1C, 0x22,
	0x00, 0x08, 0x1C, 0x08, 0x00,
	0x00, 0x00, 0x77, 0x00, 0x00,
	0x46, 0x5D, 0x55, 0x5D, 0x31,
	0x7C, 0x55, 0x54, 0x55, 0x44,
	0x08, 0x08, 0x2A, 0x08, 0x08,
	0x00, 0x14, 0x08, 0x14, 0x00,
	0x08, 0x14, 0x22, 0x08, 0x14,
	0x7F, 0x41, 0x71, 0x31, 0x1F,
	0x03, 0x05, 0x7F, 0x05, 0x03,
	0x22, 0x14, 0x7F, 0x55, 0x22,
	0x02, 0x55, 0x7D, 0x05, 0x02,
	0x06, 0x09, 0x09, 0x06, 0x00,
	0x44, 0x44, 0x5F, 0x44, 0x44,
	0x1C, 0x14, 0x1C, 0x22, 0x7F,
	0x20, 0x3E, 0x61, 0x3E, 0x20,
	0x20, 0x50, 0x3F, 0x02, 0x0C,
	0x80, 0x7C, 0x20, 0x3C, 0x40,
	0x44, 0x3C, 0x04, 0x7C, 0x44,
	0x00, 0x00, 0x08, 0x00, 0x00,
	0x38, 0x55, 0x54, 0x55, 0x18,
	0x7E, 0x08, 0x10, 0x7F, 0x01,
	0x08, 0x10, 0x08, 0x04, 0x02,
	0x14, 0x08, 0x22, 0x14, 0x08,
	0x0E, 0x06, 0x0A, 0x10, 0x20,
	0x20, 0x10, 0x0A, 0x06, 0x0E,
	0x38, 0x30, 0x28, 0x04, 0x02,
	0x02, 0x04, 0x28, 0x30, 0x38,
	0x7E, 0x11, 0x11, 0x11, 0x7E,
	0x7F, 0x49, 0x49, 0x49, 0x31,
	0x7F, 0x49, 0x49, 0x49, 0x36,
	0x7F, 0x01, 0x01, 0x01, 0x03,
	0xC0, 0x7F, 0x41, 0x7F, 0xC0,
	0x7F, 0x49, 0x49, 0x49, 0x41,
	0x77, 0x08, 0x7F, 0x08, 0x77,
	0x41, 0x49, 0x49, 0x49, 0x36,
	0x7F, 0x10, 0x08, 0x04, 0x7F,
	0x7C, 0x21, 0x12, 0x09, 0x7C,
	0x7F, 0x08, 0x14, 0x22, 0x41,
	0x40, 0x3E, 0x01, 0x01, 0x7F,
	0x7F, 0x02, 0x0C, 0x02, 0x7F,
	0x7F, 0x08, 0x08, 0x08, 0x7F,
	0x3E, 0x41, 0x41, 0x41, 0x3E,
	0x7F, 0x01, 0x01, 0x01, 0x7F,
	0x7F, 0x09, 0x09, 0x09, 0x06,
	0x3E, 0x41, 0x41, 0x41, 0x22,
	0x01, 0x01, 0x7F, 0x01, 0x01,
	0x07, 0x48, 0x48, 0x48, 0x3F,
	0x0E, 0x11, 0x7F, 0x11, 0x0E,
	0x63, 0x14, 0x08, 0x14, 0x63,
	0x7F, 0x40, 0x40, 0x7F, 0xC0,
	0x07, 0x08, 0x08, 0x08, 0x7F,
	0x7F, 0x40, 0x7F, 0x40, 0x7F,
	0x7F, 0x40, 0x7F, 0x40, 0xFF,
	0x01, 0x7F, 0x48, 0x48, 0x30,
	0x7F, 0x48, 0x48, 0x30, 0x7F,
	0x7F, 0x48, 0x48, 0x48, 0x30,
	0x22, 0x41, 0x49, 0x49, 0x3E,
	0x7F, 0x08, 0x3E, 0x41, 0x3E,
	0x46, 0x29, 0x19, 0x09, 0x7F,
	0x20, 0x54, 0x54, 0x54, 0x78,
	0x3C, 0x4A, 0x4A, 0x49, 0x31,
	0x7C, 0x54, 0x54, 0x54, 0x28,
	0x7C, 0x04, 0x04, 0x04, 0x0C,
	0xC0, 0x78, 0x44, 0x7C, 0xC0,
	0x38, 0x54, 0x54, 0x54, 0x18,
	0x6C, 0x10, 0x7C, 0x10, 0x6C,
	0x44, 0x54, 0x54, 0x54, 0x28,
	0x7C, 0x20, 0x10, 0x08, 0x7C,
	0x7C, 0x40, 0x26, 0x10, 0x7C,
	0x7C, 0x10, 0x10, 0x28, 0x44,
	0x40, 0x38, 0x04, 0x04, 0x7C,
	0x7C, 0x08, 0x10, 0x08, 0x7C,
	0x7C, 0x10, 0x10, 0x10, 0x7C,
	0x38, 0x44, 0x44, 0x44, 0x38,
	0x7C, 0x04, 0x04, 0x04, 0x7C,
	0x7C, 0x14, 0x14, 0x14, 0x08,
	0x38, 0x44, 0x44, 0x44, 0x48,
	0x04, 0x04, 0x7C, 0x04, 0x04,
	0x0C, 0x50, 0x50, 0x50, 0x3C,
	0x18, 0x24, 0xFC, 0x24, 0x18,
	0x44, 0x28, 0x10, 0x28, 0x44,
	0x7C, 0x40, 0x40, 0x7C, 0xC0,
	0x0C, 0x10, 0x10, 0x10, 0x7C,
	0x7C, 0x40, 0x7C, 0x40, 0x7C,
	0x7C, 0x40, 0x7C, 0x40, 0xFC,
	0x04, 0x7C, 0x50, 0x50, 0x20,
	0x7C, 0x50, 0x50, 0x20, 0x7C,
	0x7C, 0x50, 0x50, 0x50, 0x20,
	0x28, 0x44, 0x54, 0x54, 0x38,
	0x7C, 0x10, 0x38, 0x44, 0x38,
	0x48, 0x34, 0x14, 0x14, 0x7C
};
void rw_display_off(void) // For idle modes
{
    _cmd(SH1106_DISPLAYOFF); // 0xAE
}

void rw_display_on(void)
{
    _cmd(SH1106_DISPLAYON); // 0xAF
}

void rw_display_set_brightness(uint8_t brightness)
{
    // Wait for any ongoing drawing operations to complete
    uint32_t timeout = HAL_GetTick() + 100; // 100ms timeout
    while (oled_drawing_in_progress && HAL_GetTick() < timeout) {
        HAL_Delay(1);
    }
    
    // Brightness curve for 5% increments (Flipper Zero brightness steps)
    // Starting from 5% with proven ultra-low settings up to 100% maximum
    
    if (brightness == 0) {
        // Complete off - turn display off entirely
        _cmd(SH1106_DISPLAYOFF); // 0xAE
        return;
    }
    
    // Ensure display is on
    _cmd(SH1106_DISPLAYON); // 0xAF
    
    // Calculate percentage: brightness * 100 / 255
    uint8_t percentage = (brightness * 100) / 255;
    
    // Map percentages to our proven brightness settings
    if (percentage <= 5) {           // 5% - Ultra dim (our proven minimum)
        _cmd(0x30); // 6.4V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0x01); // Contrast 1
        _cmd(0xD9); _cmd(0x11); // Minimum pre-charge/discharge
        _cmd(0xDB); _cmd(0x00); // Minimum VCOM
        
    } else if (percentage <= 10) {    // 10% - Very dim
        _cmd(0x30); // 6.4V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0x02); // Contrast 2
        _cmd(0xD9); _cmd(0x11); // Minimum pre-charge/discharge
        _cmd(0xDB); _cmd(0x00); // Minimum VCOM
        
    } else if (percentage <= 15) {    // 15% - Dim
        _cmd(0x30); // 6.4V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0x04); // Contrast 4
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x20); // Low VCOM
        
    } else if (percentage <= 20) {    // 20% - Low
        _cmd(0x30); // 6.4V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0x08); // Contrast 8
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x25); // Low-medium VCOM
        
    } else if (percentage <= 25) {    // 25% - Low-medium
        _cmd(0x31); // 7.4V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0x10); // Contrast 16
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x30); // Medium VCOM
        
    } else if (percentage <= 30) {    // 30% - Medium-low
        _cmd(0x31); // 7.4V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0x18); // Contrast 24
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x30); // Medium VCOM
        
    } else if (percentage <= 35) {    // 35% - Medium
        _cmd(0x31); // 7.4V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0x20); // Contrast 32
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 40) {    // 40% - Medium
        _cmd(0x32); // 8.0V pump voltage (default)
        _cmd(SH1106_SETCONTRAST); _cmd(0x30); // Contrast 48
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 45) {    // 45% - Medium-high
        _cmd(0x32); // 8.0V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0x40); // Contrast 64
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 50) {    // 50% - Half brightness
        _cmd(0x32); // 8.0V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0x60); // Contrast 96
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 55) {    // 55% - Above half
        _cmd(0x32); // 8.0V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0x80); // Contrast 128
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 60) {    // 60% - Bright
        _cmd(0x33); // 9.0V pump voltage (maximum)
        _cmd(SH1106_SETCONTRAST); _cmd(0x90); // Contrast 144
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 65) {    // 65% - Bright
        _cmd(0x33); // 9.0V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0xA0); // Contrast 160
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 70) {    // 70% - Very bright
        _cmd(0x33); // 9.0V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0xB0); // Contrast 176
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 75) {    // 75% - Very bright
        _cmd(0x33); // 9.0V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0xC0); // Contrast 192
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 80) {    // 80% - Near max
        _cmd(0x33); // 9.0V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0xD0); // Contrast 208
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 85) {    // 85% - Near max
        _cmd(0x33); // 9.0V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0xE0); // Contrast 224
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 90) {    // 90% - Very high
        _cmd(0x33); // 9.0V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0xF0); // Contrast 240
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else if (percentage <= 95) {    // 95% - Almost max
        _cmd(0x33); // 9.0V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0xFC); // Contrast 252
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
        
    } else {                          // 100% - Maximum brightness
        _cmd(0x33); // 9.0V pump voltage
        _cmd(SH1106_SETCONTRAST); _cmd(0xFF); // Contrast 255 (maximum)
        _cmd(0xD9); _cmd(0x22); // Normal pre-charge/discharge
        _cmd(0xDB); _cmd(0x35); // Normal VCOM
    }
}

void rw_display_drawing_start(void)
{
    oled_drawing_in_progress = 1;
}

void rw_display_drawing_end(void)
{
    oled_drawing_in_progress = 0;
    // Small delay to ensure any pending brightness changes can complete
    HAL_Delay(1);
}